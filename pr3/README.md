# Практична робота №3

## Завдання 1

### Опис завдання
Запустіть Docker-контейнер і поекспериментуйте з максимальним лімітом 
ресурсів відкритих файлів.
Як наступне вправу, повторіть перераховані команди з root-правами.

### Опис рішення

Для запуску докера виконується команда 
> sudo docker run -it --name ulimit-test ubuntu /bin/bash

Далі для роботи необхідно створити користувача за допомогою наступної команди
> useradd -m tester

Користувач створюється з метою уникнення проблем при помилках, адже 
базово докер надає можливість працювати в root, що надає всі повноваження 
системи. Після створення користувача необхідно вибрати його за допомогою 
команди
> su - tester

Виконавши команди наведені в завданні (можна переглянути хід виконання в 
наступному підпункті) можна помітити, що визначивши ліміт, ми можемо його 
знижувати, але ми вже не маємо можливості його піднімати.

Виконання цього ж завдання з root правами не змінює результат - причиною 
того є те, що сам Docker обмежує в правах root, і тому він майже не 
відрізняється від звичайного користувача. Це можна обійти, якщо при 
запуску докера додати додатковий параметер:
> --cap-add=SYS_RESOURCE

що дозволить виокристовувати ліміт до будь-якого значення (з урахуванням 
обмеження значення ядром).

### Приклад виконання

##### Виконання з користувача tester:
```
tester@199f2d9414e1:~$ ulimit -n
1024
tester@199f2d9414e1:~$ ulimit -aS | grep "open files"
open files                          (-n) 1024
tester@199f2d9414e1:~$ ulimit -aH | grep "open files"
open files                          (-n) 524288
tester@199f2d9414e1:~$ ulimit -n 3000
tester@199f2d9414e1:~$ ulimit -aS | grep "open files"
open files                          (-n) 3000
tester@199f2d9414e1:~$ ulimit -aH | grep "open files"
open files                          (-n) 3000
tester@199f2d9414e1:~$ ulimit -n 3001
-bash: ulimit: open files: cannot modify limit: Operation not permitted
tester@199f2d9414e1:~$ ulimit -n 2000
tester@199f2d9414e1:~$ ulimit -n
2000
tester@199f2d9414e1:~$ ulimit -aS | grep "open files"
open files                          (-n) 2000
tester@199f2d9414e1:~$ ulimit -aH | grep "open files"
open files                          (-n) 2000
tester@199f2d9414e1:~$ ulimit -n 3000
-bash: ulimit: open files: cannot modify limit: Operation not permitted
```

##### Виконання з root:
```
root@199f2d9414e1:/# ulimit -n
1024
root@199f2d9414e1:/# ulimit -as | grep "open files"
open files                          (-n) 1024
root@199f2d9414e1:/# ulimit -aH | grep "open files"
open files                          (-n) 524288
root@199f2d9414e1:/# ulimit -n 3000
root@199f2d9414e1:/# ulimit -as | grep "open files"
open files                          (-n) 3000
root@199f2d9414e1:/# ulimit -aH | grep "open files"
open files                          (-n) 3000
root@199f2d9414e1:/# ulimit -n 3001
bash: ulimit: open files: cannot modify limit: Operation not permitted
```

## Завдання 2

### Опис завдання

У Docker-контейнері встановіть утиліту perf(1). 
Поекспериментуйте з досягненням процесом встановленого ліміту.

### Опис рішення

Для виконання даного завдання спершу варто встановити низький ліміт, 
щоб тестування відбувалось простіше - в даному випадку лімітом буде 50.
> ulimit -n 50

Для тестування ліміту створимо невеликий bash скрипт якйи буде 
відкривати велику кільіксть десприпторів файлів та тримати їх відкритими. 
В наведеній мною реалізації даного скрипту відкривається 60 десрипторів.

**NOTE**: як виявилося варто було ставити від 3 дискриптора, адже перші три - 
це канали зв'язку типу stdin, stdout, stderr.

```
for i in {3..60}; 
do exec {i}>"file_$i.txt"; 
echo "Відкрито дескриптор $i"; 
done
```

В результаті виконання в який момент буде виведена помилка:
> bash: redirection error: cannot duplicate fd: Too many open files

Яка свідчить про те, що ліміт був досягнутий.

**NOTE**: пізніше помітив, що ці дескриптори також необхідно за собою закрити, 
тому ось наведений скрип для цього.

```
for i in {3..60}; 
do exec {i}>&-; 
done 2>/dev/null
```

### Результати виконання

```
root@a6a3f12f2e56:/# ulimit -n 50
root@a6a3f12f2e56:/# for i in {3..60}; do exec {i}>"file_$i.txt"; echo "\320
\222\321\226\320\264\320\272\321\200\320
\270\321\202\320\276 \320\264\320\265\32
1\201\320\272\321\200\320\270\320\277\32
1\202\320\276\321\200 $i; done
Відкрито дескриптор 10
Відкрито дескриптор 11

...

Відкрито дескриптор 48
Відкрито дескриптор 49
bash: redirection error: cannot duplicate fd: Too many open files
bash: file_43.txt: Too many open files
Відкрито дескриптор 43
bash: redirection error: cannot duplicate fd: Too many open files
bash: file_44.txt: Too many open files
Відкрито дескриптор 44

...

bash: redirection error: cannot duplicate fd: Too many open files
bash: file_59.txt: Too many open files
Відкрито дескриптор 59
```

# Завдання 3

### Опис завдання

Напишіть програму, що імітує кидання шестигранного кубика. 
Імітуйте кидки, результати записуйте у файл, для якого попередньо 
встановлено обмеження на його максимальний розмір (max file size). 
Коректно обробіть ситуацію перевищення ліміту.

### Опис рішення

Використаємо функцію signal() - коли ми дійдемо до проблеми з записом 
у файл, замість того щоб обірватися програма отримає сигнал, що дає 
можливість захендлити проблему власноруч, що нам і потрібно в даному випадку.

Для правильно перевірки нам необхідно поставити ліміт, як було виконано в 
першому завданні даного практичного. Для цього так само виставимо ulimit до 
неохідного значення байтів.

**NOTE**: стикнувся з проблемою того, що створив виконуваний файл в самому 
лінуксі, а не в докері (який необзідний для тесту). Щоб вирішити цю проблему 
прив'язав папку до вмісту контейнеру докера за допомогою прапора -v при 
запуску докера.

**NOTE**: для роботи з файлами варто було використовувати прапор -f для 
ulimit, адже саме він відповідає за можливі розміри файлів.

**NOTE**: в результаті виконання утворюється файл з докера, але оскільки я 
не вибрав користувача - він створився з правами root, тому за межами root 
його не можна використовувати. Для фіксу цього варто надати поточній папці 
необхідні права, але на майбутнє краще завжди обирати користувача при вході 
в докер.

### Результати виконання

##### За межами файлу:

```
root@e3a7d14ddc9d:/app# ulimit -f 1  
root@e3a7d14ddc9d:/app# ./ex3
...................................................
Lіміт розміру файлу.
Всього записів: 52

```

##### Вміст файлу (його початок):

```
Кидок №1: 3
Кидок №2: 4
Кидок №3: 3
Кидок №4: 1
Кидок №5: 3
Кидок №6: 1
Кидок №7: 1
Кидок №8: 1
Кидок №9: 4
Кидок №10: 6
...
```
